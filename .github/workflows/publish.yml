name: publish

on:
  pull_request:
    types: [closed]
    branches:
      - master
      - stage

jobs:
  build-and-deploy:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - uses: actions/setup-node@v1
      with:
        version: '12.x'

    - name: install dependecies
      run: yarn install --production

    - name: build the assets
      run: |
        yarn g:build

    - name: choose a domain for deployment
      shell: bash
      env:
        BRANCH: ${github.ref}
      run: |
        APP_NAME=$(node -p -e "require('./package.json').name")
        APP_DOMAIN=$(if [ "$BRANCH" = "stage" ]; then echo $BRANCH.$APP_NAME; else echo $APP_NAME; fi)

    - name: deploy and read the deployment ID
      shell: bash
      env:
        CI_TOKEN: ${secrets.PUBLISHING_TOKEN}
      run: |
        DEPLOYMENT=$(npx now deploy -t $CI_TOKEN | grep https | sed -r s'/^.*https:\/\/(\S+).*$/\1/g')
        yarn now alias set $DEPLOYMENT $APP_DOMAIN -t $CI_TOKEN
        yarn now rm $APP_NAME -t $CI_TOKEN --safe --yes
